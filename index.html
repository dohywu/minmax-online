<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tracing Stack Image Reader</title>
    <style>
      :root {
        --bg: #f5f5f5;
        --fg: #111;
        --muted: #666;
        --border: #e3e3e3;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Noto Sans, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
        color: var(--fg);
        background: var(--bg);
      }
      button {
        appearance: none;
        border: 1px solid var(--border);
        background: #fff;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        cursor: pointer;
        font-size: 0.9rem;
        line-height: 1;
        box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.06);
      }
      button:hover {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }
      button:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }
      .toolbar {
        position: sticky;
        top: 0;
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 0.9rem;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: saturate(1.2) blur(6px);
        border-bottom: 1px solid var(--border);
      }
      .divider {
        width: 1px;
        height: 20px;
        background: #ddd;
        margin: 0 0.25rem;
      }
      .grow {
        flex: 1;
      }
      .counter {
        font-variant-numeric: tabular-nums;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .stage {
        position: relative;
        height: calc(100vh - 56px);
        overflow: hidden;
      }
      .grain {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0) 60%,
          rgba(0, 0, 0, 0.04)
        );
      }
      .dropzone-hint {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: var(--muted);
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
        font-size: 0.95rem;
      }
      .stage.dragover .dropzone-hint {
        opacity: 1;
      }

      .stack-root {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0 24px;
      }
      .layer {
        position: absolute;
        left: 24px;
        top: 50%;
        transform: translateY(-50%);
        will-change: transform, opacity, filter;
        transition: transform 0.35s cubic-bezier(0.2, 0.6, 0.18, 1),
          opacity 0.35s ease, filter 0.35s ease;
      }
      .page {
        display: block;
        object-fit: contain;
        object-position: left center;
        /* 크기 제어는 JS가 width/height(px)로 지정 → 원본 비율 유지 + 동일 배율 */
        user-select: none;
        -webkit-user-drag: none;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05), 0 8px 26px rgba(0, 0, 0, 0.06);
        background: none; /* 투명 PNG 유지 */
      }
      .edge-shadow {
        position: absolute;
        left: -8px;
        right: 24px;
        bottom: -6px;
        height: 14px;
        filter: blur(6px);
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.08),
          transparent
        );
        pointer-events: none;
      }

      .floating-controls {
        position: absolute;
        left: 16px;
        bottom: 16px;
        display: flex;
        gap: 8px;
      }
      .hint {
        position: absolute;
        right: 16px;
        bottom: 16px;
        font-size: 0.8rem;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(6px);
        border: 1px solid var(--border);
        padding: 4px 8px;
        border-radius: 8px;
      }
      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.9rem;
      }
      input[type='checkbox'] {
        width: 16px;
        height: 16px;
      }
      .kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        background: #fff;
        border: 1px solid var(--border);
        padding: 2px 6px;
        border-radius: 6px;
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.05);
      }
      @media (max-width: 640px) {
        .layer {
          left: 16px;
        }
        .stack-root {
          padding: 0 16px;
        }
      }
    </style>
  </head>
  <body>
    <header class="toolbar" role="toolbar" aria-label="Controls">
      <span id="counter" class="counter">0 / 0</span>
      <div class="divider" aria-hidden="true"></div>
      <button id="prevBtn" type="button" aria-label="Previous (←)">Prev</button>
      <button id="nextBtn" type="button" aria-label="Next (→/Space)">
        Next
      </button>
      <div class="divider" aria-hidden="true"></div>
      <label class="toggle" title="세로 맞춤(F)">
        <input id="fitHeightToggle" type="checkbox" checked />
        Fit to height
      </label>
      <div class="grow"></div>
      <label class="toggle" for="fileInput">
        <input
          id="fileInput"
          type="file"
          accept="image/*"
          multiple
          style="display: none"
        />
        <button
          type="button"
          onclick="document.getElementById('fileInput').click()"
        >
          이미지 업로드
        </button>
      </label>
    </header>

    <main id="stage" class="stage" aria-live="polite">
      <div class="grain" aria-hidden="true"></div>
      <div class="dropzone-hint" id="dropHint">
        이미지를 여기로 드래그 앤 드롭<br />(다중 선택 가능)
      </div>
      <div class="stack-root" id="stackRoot"></div>

      <div class="floating-controls">
        <button id="prevBtn2" type="button">← Prev</button>
        <button id="nextBtn2" type="button">Next →</button>
      </div>
      <div class="hint">
        ←/→ 또는 Space • <span class="kbd">F</span> = 맞춤 전환
      </div>
    </main>

    <script>
      // ---------------------------
      // State
      // ---------------------------
      const demo = [
        'https://dohywu.github.io/minmax-online/src/image/1.png',
        'https://dohywu.github.io/minmax-online/src/image/2.png',
        'https://dohywu.github.io/minmax-online/src/image/3.png',
        'https://dohywu.github.io/minmax-online/src/image/4-1.png',
        'https://dohywu.github.io/minmax-online/src/image/4-2.png',
        'https://dohywu.github.io/minmax-online/src/image/4-3.png',
        'https://dohywu.github.io/minmax-online/src/image/5.png',
        'https://dohywu.github.io/minmax-online/src/image/6-1.png',
        'https://dohywu.github.io/minmax-online/src/image/6-2.png',
        'https://dohywu.github.io/minmax-online/src/image/7.png',
        'https://dohywu.github.io/minmax-online/src/image/8.png',
        'https://dohywu.github.io/minmax-online/src/image/9.png',
        'https://dohywu.github.io/minmax-online/src/image/10.png',
        'https://dohywu.github.io/minmax-online/src/image/11.png',
        'https://dohywu.github.io/minmax-online/src/image/12.png',
        'https://dohywu.github.io/minmax-online/src/image/13.png',
        'https://dohywu.github.io/minmax-online/src/image/14.png',
        'https://dohywu.github.io/minmax-online/src/image/15.png',
        'https://dohywu.github.io/minmax-online/src/image/16.png',
        'https://dohywu.github.io/minmax-online/src/image/17.png',
        'https://dohywu.github.io/minmax-online/src/image/18.png',
        'https://dohywu.github.io/minmax-online/src/image/19.png',
        'https://dohywu.github.io/minmax-online/src/image/20.png',
        'https://dohywu.github.io/minmax-online/src/image/21.png',
        'https://dohywu.github.io/minmax-online/src/image/22.png',
        'https://dohywu.github.io/minmax-online/src/image/23.png',
        'https://dohywu.github.io/minmax-online/src/image/24.png',
        'https://dohywu.github.io/minmax-online/src/image/25.png',
        'https://dohywu.github.io/minmax-online/src/image/26.png',
        'https://dohywu.github.io/minmax-online/src/image/27.png',
        'https://dohywu.github.io/minmax-online/src/image/28.png',
        'https://dohywu.github.io/minmax-online/src/image/29.png',
      ];

      let pages = [...demo]; // 이미지 URL 배열
      let metas = []; // 각 이미지의 자연 크기 {w,h}
      let index = 0; // 현재 맨 앞 장
      let fitHeight = true; // 세로 기준 맞춤 토글
      let objectURLs = []; // 업로드 리소스 해제용
      let scale = 1; // 모든 레이어에 공통 적용할 배율

      // 요소
      const stackRoot = document.getElementById('stackRoot');
      const counter = document.getElementById('counter');
      const thePrevBtns = [
        document.getElementById('prevBtn'),
        document.getElementById('prevBtn2'),
      ];
      const theNextBtns = [
        document.getElementById('nextBtn'),
        document.getElementById('nextBtn2'),
      ];
      const fitHeightToggle = document.getElementById('fitHeightToggle');
      const fileInput = document.getElementById('fileInput');
      const stage = document.getElementById('stage');
      const dropHint = document.getElementById('dropHint');

      function preload(src) {
        const img = new Image();
        img.src = src;
      }
      function updateCounter() {
        counter.textContent = `${pages.length ? index + 1 : 0} / ${
          pages.length
        }`;
      }
      function updateButtons() {
        const canPrev = index > 0,
          canNext = index < pages.length - 1;
        thePrevBtns.forEach((b) => (b.disabled = !canPrev));
        theNextBtns.forEach((b) => (b.disabled = !canNext));
      }

      // 모든 이미지 natural size 메타 만들기
      function buildMetas(urls) {
        return Promise.all(
          urls.map(
            (src) =>
              new Promise((res) => {
                const img = new Image();
                img.onload = () =>
                  res({
                    w: img.naturalWidth || img.width,
                    h: img.naturalHeight || img.height,
                  });
                img.onerror = () => res({ w: 0, h: 0 });
                img.src = src;
              })
          )
        );
      }

      // 화면 기준 통일 배율 계산 (업스케일 금지)
      function computeUniformScale() {
        if (!metas.length) {
          scale = 1;
          return;
        }
        // 가장 큰 폭/높이 찾기
        const maxW = Math.max(...metas.map((m) => m.w || 0));
        const maxH = Math.max(...metas.map((m) => m.h || 0));
        const vw = stage.clientWidth,
          vh = stage.clientHeight;
        const maxAllowedW = Math.floor(vw * 0.8);
        const maxAllowedH = Math.floor(vh * 0.8);

        if (fitHeight) {
          const s = maxH > 0 ? maxAllowedH / maxH : 1;
          scale = Math.min(s, 1); // 확대 금지
        } else {
          const s = maxW > 0 ? maxAllowedW / maxW : 1;
          scale = Math.min(s, 1);
        }
      }

      function invalidateAndRender() {
        computeUniformScale();
        render();
      }

      function setPagesFromFiles(fileList) {
        // 기존 ObjectURL 해제
        objectURLs.forEach((url) => URL.revokeObjectURL(url));
        objectURLs = [];
        pages = Array.from(fileList)
          .filter((f) => f.type.startsWith('image/'))
          .map((f) => {
            const url = URL.createObjectURL(f);
            objectURLs.push(url);
            return url;
          });

        index = 0;
        dropHint.style.display = pages.length ? 'none' : 'grid';
        buildMetas(pages).then((m) => {
          metas = m;
          invalidateAndRender();
        });
      }

      function attachDragAndDrop() {
        stage.addEventListener('dragover', (e) => {
          e.preventDefault();
          stage.classList.add('dragover');
        });
        stage.addEventListener('dragleave', () =>
          stage.classList.remove('dragover')
        );
        stage.addEventListener('drop', (e) => {
          e.preventDefault();
          stage.classList.remove('dragover');
          if (e.dataTransfer?.files?.length)
            setPagesFromFiles(e.dataTransfer.files);
        });
      }

      // 렌더링
      function render() {
        stackRoot.innerHTML = '';
        updateCounter();
        updateButtons();
        if (!pages.length) return;

        for (let i = index; i < pages.length; i++) {
          const depth = i - index; // 0 = 맨 앞
          const z = 1000 - i;

          // 거리감 (뒤로 갈수록 더 흐리고 살짝 회색)
          const opacity = depth === 0 ? 1 : Math.max(0.18, 0.6 - depth * 0.12);
          const blurPx = Math.min(10, depth * 1.8);
          const grayPct = Math.min(60, depth * 10);
          const yOffset = depth * 2;
          const xJitter = depth * 1;

          const layer = document.createElement('div');
          layer.className = 'layer';
          layer.style.zIndex = z;
          layer.style.transform = `translateY(calc(-50% + ${yOffset}px)) translateX(${xJitter}px)`;

          const img = document.createElement('img');
          img.className = 'page';
          img.alt = `page-${i + 1}`;
          img.src = pages[i];

          // 원본 사이즈 × 통일 배율 (업스케일 없음)
          const meta = metas[i] || { w: 0, h: 0 };
          if (meta.w && meta.h) {
            img.style.width = Math.round(meta.w * scale) + 'px';
            img.style.height = Math.round(meta.h * scale) + 'px';
          } else {
            // 메타 못 얻은 경우 안전장치 (대략 화면 기준)
            const vw = stage.clientWidth,
              vh = stage.clientHeight;
            img.style.maxWidth = Math.floor(vw * 0.8) + 'px';
            img.style.maxHeight = Math.floor(vh * 0.8) + 'px';
          }

          img.style.filter = `blur(${blurPx}px) grayscale(${grayPct}%)`;
          img.style.opacity = opacity;

          const edge = document.createElement('div');
          edge.className = 'edge-shadow';

          layer.appendChild(img);
          layer.appendChild(edge);
          stackRoot.appendChild(layer);
        }

        // 다음 것들 미리 로드
        for (let k = 1; k <= 3; k++)
          if (index + k < pages.length) preload(pages[index + k]);
      }

      // 이벤트
      thePrevBtns.forEach((btn) =>
        btn.addEventListener('click', () => {
          if (index > 0) {
            index--;
            render();
          }
        })
      );
      theNextBtns.forEach((btn) =>
        btn.addEventListener('click', () => {
          if (index < pages.length - 1) {
            index++;
            render();
          }
        })
      );

      fitHeightToggle.addEventListener('change', (e) => {
        fitHeight = !!e.target.checked;
        invalidateAndRender();
      });

      fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (!files?.length) return;
        setPagesFromFiles(files);
      });

      window.addEventListener('keydown', (e) => {
        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName))
          return;
        if (e.key === 'ArrowRight' || e.key === ' ') {
          theNextBtns[0].click();
          e.preventDefault();
        }
        if (e.key === 'ArrowLeft') {
          thePrevBtns[0].click();
          e.preventDefault();
        }
        if (e.key.toLowerCase() === 'f') {
          fitHeightToggle.checked = !fitHeightToggle.checked;
          fitHeight = fitHeightToggle.checked;
          invalidateAndRender();
        }
      });

      window.addEventListener('resize', () => invalidateAndRender());

      window.addEventListener('beforeunload', () => {
        objectURLs.forEach((url) => URL.revokeObjectURL(url));
      });

      // 초기화
      attachDragAndDrop();
      (pages.length ? buildMetas(pages) : Promise.resolve([])).then((m) => {
        metas = m;
        invalidateAndRender();
      });
    </script>
  </body>
</html>
